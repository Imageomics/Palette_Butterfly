#!/bin/bash
#SBATCH --account=PAS2136
#SBATCH --job-name=Color_Palette
#SBATCH --time=00:30:00
#SBATCH --ntasks=8

# Stop if a command fails (non-zero exit status)
set -e

# command line arguments
DATA_DIR=$1

# Make sure the DATA_DIR dir exists
if [ ! -d "$DATA_DIR" ]
then
   echo "ERROR: Required DATA_DIR $DATA_DIR does not exist."
   exit 1
fi

cd $SLURM_SUBMIT_DIR

#copy to compute node storage
cp  Snakefile $TMPDIR
cp  metadata_palette.py $TMPDIR
cp -r .snakemake $TMPDIR
cp -r output $TMPDIR

cd $TMPDIR
mkdir Images
cp -r $DATA_DIR/* Images/


PARENT=$(dirname $DATA_DIR)

# Activate Snakemake environment
module load miniconda3/4.10.3-py37
# Activate using source per OSC instructions
source activate snakemake

#execute
snakemake --cores $SLURM_NTASKS --use-singularity

# Copy the snakemake ouputs to the PARENT folder 
PARENT=$(dirname $DATA_DIR)
cp -r CSV $PARENT
cp -r JSON $PARENT
cp -r Pre_images $PARENT

chmod -R 774 $PARENT/CSV 
chmod -R 774 $PARENT/JSON 
chmod -R 774 $PARENT/Pre_images

